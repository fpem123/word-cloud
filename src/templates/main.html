<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Main</title>
</head>
<script type="text/javascript">

    function send_list_req(){
        const youtuber = document.getElementById("yname").value;

        if (youtuber == ''){
            alert("Please fill youtuber name");
            return;
        }

        const formData = new FormData();
        const url = "/word-cloud/find_youtuber";

        formData.append('youtuber', youtuber);

        fetch (url, { method:'POST', body: formData, })
        .then(response => {
            if (response.status === 200) {
                return response.json();
            } else {
                alert('nope');
            }
        }).catch(err => {
            alert(err);
        }).then(data => {
            const table = document.getElementById('ytable');

            for(let i=0; i <= table.rows.length; i++)
                table.deleteRow(-1);

            let idx = 0;

            for (key in data){
                const new_row = table.insertRow();
                const name = new_row.insertCell(0);
                const cell1 = new_row.insertCell(1);
                const cell2 = new_row.insertCell(2);

                name.innerText = data[key][0];
                cell1.innerText = data[key][1];
                cell2.innerHTML = `<button id="idx${idx}" onclick="send_table_req(${idx});">Make!</button>`;

                idx++;
            }
        });
    }

    function get_img(channel){
        const url = "/word-cloud/make_wordcloud";
        const formData = new FormData();

        formData.append('youtube_url', channel);

        fetch (url, { method:'POST', body: formData, })
        .then(response => {
            if (response.status === 200) {
                return response.blob();
            } else {
                alert('URL error try again');
            }
        }).catch(err => {
            alert('err');
        }).then(blob => {
             return URL.createObjectURL(blob);
        }).then(imageURL =>{
            document.getElementById('result_image').style.display = "block";
            document.getElementById('result_image').src = imageURL;
        }).catch(err => {
            alert('Image error try again');
        });
    }

    function send_img_req(){
        const channel = document.getElementById("uname").value;

        if (channel == ''){
            alert("Please fill youtuber url");
            return;
        }

        get_img(channel);
    }

    function send_table_req(idx){
        const channel = document.getElementById('ytable').getElementsByTagName('td')[idx * 3 + 1].innerText;

        get_img(channel);
    }

</script>
<body>
    <div class="container">
        <div class="application">
            <from method="POST" id="dataReq">
                <div>
                    <p><b>Find youtuber</b></p>
                    <label>Find list: Find youtuber channel</label><br>
                </div>

                <div class="inputText">
                    <label>youtuber: </label>
                    <input type="text" id="yname" name="youtuber">
                </div>

                <div>
                    <button type="submit" id="button1" onclick="send_list_req();">RUN</button>
                </div>
            </from>

            <br>

            <div id="tresult">
                <p><b>Result table</b></p>
                <div id="result_table">
                    <table id="ytable">
                    </table>
                </div>
            </div>

            <hr>

            <from method="POST" id="imgReq">
                <div>
                    <p><b>Make word cloud</b></p>
                    <label>Make word cloud: Make word cloud using part of url</label><br>
                </div>

                <div class="inputText">
                    <label>youtuber url: </label>
                    <input type="text" id="uname" name="youtuber">
                </div>

                <div>
                    <button type="submit" id="button2" onclick="send_img_req();">RUN</button>
                </div>
            </from>

            <br>

            <div id="iresult">
                <p><b>Result image</b></p>
                <img id="result_image" src="" alt="">
            </div>
        </div>
    </div>
</body>
</html>