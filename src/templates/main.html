<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Main</title>
</head>
<script type="text/javascript">
    let table_time_obj = undefined;
    let image_time_obj = undefined;
    let timer = undefined;

    window.onload = () => {
        table_time_obj = document.getElementById("ttimer");
        image_time_obj = document.getElementById("itimer");
    }

    function send_list_req(){
        const youtuber = document.getElementById("yname").value;

        if (youtuber == ''){
            alert("Please fill youtuber name");
            return;
        }

        const formData = new FormData();
        const url = "/word-cloud/find_youtuber";
        let start = 0;

        formData.append('youtuber', youtuber);

        timer = setInterval(() => {
            start += 1;
            table_time_obj.innerText = `${start / 10} 's`;
        }, 100);

        fetch (url, { method:'POST', body: formData, })
        .then(response => {
            if (response.status === 200) {
                return response.json();
            } else {
                clearInterval(timer);
                alert('nope');
            }
        }).catch(err => {
            clearInterval(timer);
            alert(err);
        }).then(data => {
            const table = document.getElementById('ytable');

            for(let i=0; i <= table.rows.length; i++)
                table.deleteRow(-1);

            let idx = 0;

            for (key in data){
                const new_row = table.insertRow();
                const name = new_row.insertCell(0);
                const cell1 = new_row.insertCell(1);
                const cell2 = new_row.insertCell(2);

                name.innerText = data[key][0];
                cell1.innerText = data[key][1];
                cell2.innerHTML = `<button id="idx${idx}" onclick="send_table_req(${idx});">Make!</button>`;

                idx++;
            }
            clearInterval(timer);
            table_time_obj.innerText = 'Done!';
        }).catch(err => {
            clearInterval(timer);
            alert(err);
        });
    }

    function get_img(channel){
        const url = "/word-cloud/make_wordcloud";
        const formData = new FormData();
        let start = 0;

        formData.append('youtube_url', channel);

        timer = setInterval(() => {
            start += 1;
            image_time_obj.innerText = `${start / 10} 's`;
        }, 100);

        fetch (url, { method:'POST', body: formData, })
        .then(response => {
            if (response.status === 200) {
                return response.blob();
            } else {
                alert('URL error try again');
                clearInterval(timer);
            }
        }).catch(err => {
            clearInterval(timer);
            alert('err');
        }).then(blob => {
             return URL.createObjectURL(blob);
        }).then(imageURL =>{
            document.getElementById('sample').style.display = 'none';
            document.getElementById('result_image').style.display = "block";
            document.getElementById('result_image').src = imageURL;
            document.getElementById('irt').innerText = 'Result image';
            clearInterval(timer);
            image_time_obj.innerText = 'Done!';
        }).catch(err => {
            clearInterval(timer);
            alert('Image error try again');
        });
    }

    function send_img_req(){
        const channel = document.getElementById("uname").value;

        if (channel == ''){
            alert("Please fill youtuber url");
            return;
        }

        get_img(channel);
    }

    function send_table_req(idx){
        const channel = document.getElementById('ytable').getElementsByTagName('td')[idx * 3 + 1].innerText;

        get_img(channel);
    }

</script>
<body>
    <div class="container">
        <div class="application">
            <from method="POST" id="dataReq">
                <div class="desc">
                    <p><b>Find youtuber</b></p>
                    <label>Find youtuber channel. Try it!</label><br>
                </div>

                <div class="inputText">
                    <label>youtuber: </label>
                    <input type="text" id="yname" name="youtuber" size="25">
                </div>

                <div class="button">
                    <button type="submit" id="button1" onclick="send_list_req();">Find!</button>
                </div>
            </from>

            <br>

            <div id="tresult">
                <p><b>Result table</b></p>
                <strong id="ttimer">Table will set here.</strong>
                <div id="result_table">
                    <table id="ytable">
                    </table>
                </div>
            </div>

            <hr>

            <from method="POST" id="imgReq">
                <div class="desc">
                    <p><b>Make word cloud</b></p>
                    <label>You can make a word cloud by pressing 'Make!' button in table<br>
                        or using part of url!</label><br>
                    <img src="../static/url_exam.png" width="500"><br>
                </div>

                <div class="inputText">
                    <label>youtuber url: </label>
                    <input type="text" id="uname" name="youtuber" placeholder="/channel/UCnyBeZ5iEdlKrAcfNbZ-wog" size="50">
                </div>

                <div class="button">
                    <button type="submit" id="button2" onclick="send_img_req();">Make!</button>
                </div>
            </from>

            <br>

            <div id="iresult">
                <p><b id="irt">Sample image</b></p>
                <strong id="itimer"></strong>
                <img id="result_image" src="" alt="">
            </div>

            <div id="sample">
                <img src="../static/wordcloud_sample.jpeg">
            </div>
        </div>
    </div>
</body>
</html>